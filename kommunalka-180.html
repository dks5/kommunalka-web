<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет Коммунальных Услуг</title>
    <!-- Tailwind CSS CDN для быстрой и адаптивной стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Основной шрифт Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #1f2937;
        }
        .app-container {
            min-height: 100vh;
        }
        /* Управление видимостью мобильного меню */
        .nav-menu.hidden-mobile {
            display: none;
        }
        @media (min-width: 640px) {
            .nav-menu.hidden-mobile {
                display: flex !important;
            }
        }
        /* Стиль активной вкладки */
        .nav-item a.current-view {
            background-color: #1e40af; /* Blue-800 */
            border-bottom-color: #dbeafe; /* Blue-100 */
        }
    </style>
</head>
<body>
    <div id="app" class="app-container flex flex-col">
        <!-- Шапка и Навигация -->
        <header class="bg-blue-600 text-white shadow-lg sticky top-0 z-10">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex flex-col sm:flex-row sm:items-baseline">
                    <h1 class="text-xl font-bold">Коммунальные Платежи</h1>
                    <!-- Добавление лицевого счета. Виден на всех страницах -->
                    <span class="text-sm font-light opacity-80 sm:ml-4 mt-[-4px] sm:mt-0">Л/С №120180</span>
                </div>
                
                <!-- Кнопка Бургер-меню (только для мобильных) -->
                <button id="menu-toggle" class="sm:hidden p-2 rounded-full hover:bg-blue-700 transition duration-150">
                    <!-- Иконка бургер-меню -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
            
            <!-- Меню навигации (сворачивается на мобильных) -->
            <nav id="nav-menu" class="bg-blue-700 sm:block hidden-mobile">
                <ul class="flex flex-col sm:flex-row text-center sm:text-left">
                    <!-- Элементы навигации. data-view используется для переключения контента. -->
                    <li class="nav-item">
                        <a href="#" data-view="Summary" class="block p-4 sm:px-6 hover:bg-blue-800 transition duration-150 border-b-2 border-blue-700 sm:border-b-0 current-view">Сводка</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" data-view="Water" class="block p-4 sm:px-6 hover:bg-blue-800 transition duration-150 border-b-2 border-blue-700 sm:border-b-0">Вода</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" data-view="Electricity" class="block p-4 sm:px-6 hover:bg-blue-800 transition duration-150 border-b-2 border-blue-700 sm:border-b-0">Электроэнергия</a>
                    </li>
                    <!-- ИЗМЕНЕНО: Тепловая энергия (Heat) -->
                    <li class="nav-item">
                        <a href="#" data-view="Heat" class="block p-4 sm:px-6 hover:bg-blue-800 transition duration-150 border-b-2 border-blue-700 sm:border-b-0">Тепло</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" data-view="Garbage" class="block p-4 sm:px-6 hover:bg-blue-800 transition duration-150 border-b-2 border-blue-700 sm:border-b-0">Экооператор (Мусор)</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" data-view="ManagementCompany" class="block p-4 sm:px-6 hover:bg-blue-800 transition duration-150 border-b-2 border-blue-700 sm:border-b-0">УК Восточный луч</a>
                    </li>
                </ul>
            </nav>
        </header>

        <!-- Основная область контента -->
        <main class="flex-grow container mx-auto p-4 sm:p-6">
            <!-- Глобальное окно сообщений (замена alert()) -->
            <div id="message-box" class="fixed top-20 right-4 p-3 rounded-lg shadow-xl text-white z-50 transition-opacity duration-300 opacity-0 hidden"></div>
            
            <!-- Контейнеры для каждого "экрана" (представления) -->
            <div id="content-views">
                <!-- Сводка (по умолчанию видна) -->
                <div id="Summary-view" class="view-content"></div>
                
                <!-- Остальные представления скрыты по умолчанию -->
                <div id="Water-view" class="view-content hidden"></div>
                <div id="Electricity-view" class="view-content hidden"></div>
                <!-- НОВЫЙ КОНТЕЙНЕР ДЛЯ ТЕПЛА -->
                <div id="Heat-view" class="view-content hidden"></div>
                <div id="Garbage-view" class="view-content hidden"></div>
                <div id="ManagementCompany-view" class="view-content hidden"></div>
            </div>

            <!-- Глобальный индикатор загрузки -->
            <div id="global-loading" class="flex justify-center items-center h-48">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
            
        </main>

    </div>

    <!-- JavaScript Logic (Module Type for Firebase) -->
    <script type="module">
        // Импорты Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, orderBy, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Глобальные переменные Canvas среды для Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let isAuthReady = false;
        let allReadings = {}; // Мастер-объект для хранения всех данных

        // --- Вспомогательные функции ---

        /** Показывает временное сообщение вместо alert() */
        function showMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.classList.remove('bg-green-500', 'bg-red-500', 'hidden', 'opacity-0');
            
            if (type === 'success') {
                box.classList.add('bg-green-500');
            } else if (type === 'error') {
                box.classList.add('bg-red-500');
            }

            box.classList.remove('opacity-0');
            box.classList.add('opacity-100');
            box.style.display = 'block';

            // Скрытие через 3 секунды
            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => {
                    box.style.display = 'none';
                }, 300);
            }, 3000);
        }

        /** Форматирование метки времени в читаемую дату */
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        /** Форматирование суммы в валюту (RUB) */
        function formatCurrency(amount) {
            // Проверка на корректное число
            if (typeof amount !== 'number' || isNaN(amount)) {
                amount = 0;
            }
            return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 2 }).format(amount);
        }
        
        /** Получает название месяца по индексу (0-11) */
        function getMonthName(monthIndex) {
            const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            return months[monthIndex];
        }

        /** Получает уникальные года, имеющиеся в данных */
        function getAvailableYears(allData) {
            const years = new Set();
            // Используем Object.keys(allData) для безопасной итерации
            Object.keys(allData).forEach(service => {
                const readings = allData[service] || []; // Безопасное получение массива
                readings.forEach(item => {
                    if (item.createdAt) {
                        years.add(item.createdAt.toDate().getFullYear());
                    }
                });
            });
            return Array.from(years).sort((a, b) => b - a);
        }

        
        // --- Настройка Firebase и Аутентификация ---

        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                setPersistence(auth, browserSessionPersistence);
                
                // Аутентификация: сначала пробуем кастомный токен, затем анонимный вход
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .catch(error => {
                            console.error("Custom token sign-in failed. Falling back to anonymous.", error);
                            signInAnonymously(auth);
                        });
                } else {
                    signInAnonymously(auth);
                }

                // Слушатель состояния аутентификации
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        document.getElementById('global-loading').classList.add('hidden');
                        
                        // Запуск слушателей данных только после готовности авторизации
                        setupRealtimeListeners();
                    } else {
                        isAuthReady = false;
                        document.getElementById('global-loading').classList.remove('hidden');
                    }
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                document.getElementById('global-loading').innerHTML = '<p class="text-red-600">Ошибка инициализации базы данных. Проверьте конфигурацию.</p>';
            }
        }

        // --- Работа с данными Firestore ---

        /** Получает путь к публичной коллекции для всех данных */
        function getCollectionPath() {
            // Используем ПУБЛИЧНЫЙ путь для сохранения данных, не привязанных к уникальному ID
            // Путь: /artifacts/{appId}/public/data/utility_readings
            return `/artifacts/${appId}/public/data/utility_readings`;
        }
        
        /** Добавляет новую запись в Firestore */
        async function addReading(service, readingData) {
            if (!isAuthReady) {
                showMessage('Подождите, идет авторизация...', 'error');
                return false;
            }
            try {
                const collectionRef = collection(db, getCollectionPath());
                
                const dataToSave = {
                    ...readingData,
                    service: service,
                    reading: parseFloat(readingData.reading || 0), // Default to 0 if not metered
                    cost: parseFloat(readingData.cost),
                    notes: readingData.notes || '',
                    createdAt: serverTimestamp() // Время создания на сервере для сортировки
                };

                await addDoc(collectionRef, dataToSave);
                showMessage(`Данные по ${getServiceDisplayName(service)} успешно добавлены!`);
                return true;
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('Ошибка при добавлении данных. Проверьте консоль.', 'error');
                return false;
            }
        }
        
        // --- Реагирование на изменения данных в реальном времени ---

        const serviceKeys = ['Water', 'Electricity', 'Heat', 'Garbage', 'ManagementCompany'];
        
        /** Настраивает onSnapshot для получения всех данных в реальном времени */
        function setupRealtimeListeners() {
            const collectionRef = collection(db, getCollectionPath());
            
            // Запрос: все записи, отсортированные по времени создания (новые сверху)
            const q = query(collectionRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                const newReadings = {};
                serviceKeys.forEach(key => newReadings[key] = []); // Гарантируем, что все ключи существуют и являются массивами

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    // Преобразование в числа
                    data.reading = data.reading ? parseFloat(data.reading) : 0;
                    data.cost = data.cost ? parseFloat(data.cost) : 0;
                    
                    if (data.service && newReadings[data.service]) {
                        newReadings[data.service].push({ id: doc.id, ...data });
                    }
                });
                
                allReadings = newReadings;
                
                // Перерисовка всех представлений с новыми данными
                // При обновлении данных, мы перерисовываем Сводку с текущими выбранными фильтрами
                const currentYear = parseInt(document.getElementById('summary-year')?.value || new Date().getFullYear());
                const currentMonth = parseInt(document.getElementById('summary-month')?.value || new Date().getMonth());
                
                renderSummaryView(allReadings, currentYear, currentMonth);
                serviceKeys.forEach(service => renderServiceView(service, allReadings[service]));
                
            }, (error) => {
                console.error("Error setting up real-time listener: ", error);
                showMessage('Ошибка получения данных в реальном времени.', 'error');
            });
        }
        
        // --- Логика рендеринга представлений ---

        function getServiceDisplayName(key) {
            const names = {
                'Water': 'Вода',
                'Electricity': 'Электроэнергия',
                'Heat': 'Тепло', // ИЗМЕНЕНО
                'Garbage': 'Экооператор (Мусор)',
                'ManagementCompany': 'УК Восточный луч',
                'Summary': 'Сводка'
            };
            return names[key] || key;
        }
        
        /** Проверка, требуется ли счетчик для услуги */
        function isMetered(service) {
            // Теперь Тепловая энергия также со счетчиком (Гкал)
            return ['Water', 'Electricity', 'Heat'].includes(service);
        }

        /** Рендеринг таблицы истории платежей */
        function renderHistoryTable(service, readings) {
            const metered = isMetered(service);
            
            const tableRows = readings.map((r, index) => {
                // Предыдущее показание для расчета расхода
                const previousReading = (index < readings.length - 1) ? readings[index + 1].reading : null;
                const consumption = previousReading !== null ? r.reading - previousReading : null;

                return `
                    <tr class="border-b hover:bg-gray-50 transition duration-100">
                        <td class="px-2 py-3 sm:p-3 text-sm font-medium text-gray-900">${r.createdAt ? formatDate(r.createdAt) : 'N/A'}</td>
                        ${metered ? `<td class="px-2 py-3 sm:p-3 text-sm">${r.reading.toFixed(2)}</td>` : ''}
                        ${metered ? `<td class="px-2 py-3 sm:p-3 text-sm text-blue-600">${consumption !== null ? consumption.toFixed(2) : '-'}</td>` : ''}
                        <td class="px-2 py-3 sm:p-3 text-sm font-semibold">${formatCurrency(r.cost)}</td>
                        <td class="px-2 py-3 sm:p-3 text-xs text-gray-500 max-w-xs truncate">${r.notes || '-'}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">История платежей</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-3 sm:p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
                                    ${metered ? `<th class="px-2 py-3 sm:p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Показание</th>` : ''}
                                    ${metered ? `<th class="px-2 py-3 sm:p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Расход</th>` : ''}
                                    <th class="px-2 py-3 sm:p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Стоимость</th>
                                    <th class="px-2 py-3 sm:p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Примечания</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows.length > 0 ? tableRows : `<tr><td colspan="${metered ? 5 : 3}" class="text-center p-4 text-gray-500">Нет данных. Добавьте первую запись!</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        /** Рендеринг формы ввода данных */
        function renderForm(service) {
            const metered = isMetered(service);
            const displayName = getServiceDisplayName(service);
            let placeholderReading = 'Например, 123.45';
            
            if (service === 'Water') placeholderReading = 'Общий м³';
            else if (service === 'Electricity') placeholderReading = 'Общий кВтч';
            else if (service === 'Heat') placeholderReading = 'Общий Гкал';


            return `
                <form id="${service}-form" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Добавить новые данные (Факт)</h3>

                    ${metered ? `
                        <div class="mb-4">
                            <label for="${service}-reading" class="block text-sm font-medium text-gray-700 mb-1">Текущее показание счетчика (${service === 'Water' ? 'Общий м³' : service === 'Electricity' ? 'Общий кВтч' : 'Общий Гкал'})</label>
                            <input type="number" step="0.01" id="${service}-reading" name="reading" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm" placeholder="${placeholderReading}">
                        </div>
                    ` : `
                        <p class="text-sm text-gray-500 mb-4">Для этой услуги вносится только сумма платежа.</p>
                        <input type="hidden" name="reading" value="0">
                    `}

                    <div class="mb-4">
                        <label for="${service}-cost" class="block text-sm font-medium text-gray-700 mb-1">Сумма к оплате (руб.)</label>
                        <input type="number" step="0.01" id="${service}-cost" name="cost" required 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm" placeholder="Например, 1500.50">
                    </div>

                    <div class="mb-6">
                        <label for="${service}-notes" class="block text-sm font-medium text-gray-700 mb-1">Примечания (необязательно)</label>
                        <textarea id="${service}-notes" name="notes" rows="2" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm" placeholder="Комментарий к платежу или тариф"></textarea>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md transform hover:scale-[1.01] active:scale-[0.99]">
                        Сохранить данные по ${displayName}
                    </button>
                </form>
            `;
        }
        
        /** Рендеринг информационного блока о последних данных */
        function renderLatestInfoContent(service, readings) {
            const latest = readings.length > 0 ? readings[0] : null;
            const previous = readings.length > 1 ? readings[1] : null;
            const metered = isMetered(service);
            
            let consumptionInfo = '';
            if (latest && previous && metered) {
                const consumption = latest.reading - previous.reading;
                let unit = '';
                if (service === 'Water') unit = 'м³';
                else if (service === 'Electricity') unit = 'кВтч';
                else if (service === 'Heat') unit = 'Гкал';

                consumptionInfo = `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-gray-600 font-semibold mb-2">Расход за период:</p>
                        <p class="text-3xl font-bold text-blue-600">${consumption.toFixed(service === 'Heat' ? 6 : 2)}</p>
                        <p class="text-sm text-gray-500">${unit}</p>
                    </div>
                `;
            } else if (metered && readings.length < 2) {
                consumptionInfo = `<p class="mt-4 pt-4 border-t border-gray-200 text-sm text-gray-500">Нужно минимум 2 показания для расчета расхода.</p>`;
            }

            return `
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Последние данные</h3>
                ${latest ? `
                    <div class="space-y-3">
                        <p><strong>Дата внесения:</strong> <span class="text-blue-600">${formatDate(latest.createdAt)}</span></p>
                        ${metered ? `<p><strong>Последнее показание:</strong> <span class="text-blue-600 font-medium">${latest.reading.toFixed(service === 'Heat' ? 6 : 2)}</span></p>` : ''}
                        <p><strong>Последняя сумма:</strong> <span class="text-red-600 font-bold text-xl">${formatCurrency(latest.cost)}</span></p>
                        <p class="text-sm text-gray-500 mt-2"><strong>Примечание:</strong> ${latest.notes || '-'}</p>
                    </div>
                    ${consumptionInfo}
                ` : `
                    <p class="text-gray-500">Данные по ${getServiceDisplayName(service)} отсутствуют. Добавьте первую запись.</p>
                `}
            `;
        }
        
        /** Рендеринг калькулятора тарифов */
        function renderCalculatorBlock(service, readings) {
            if (!isMetered(service)) return '';

            const latestReading = (readings && readings.length > 0) ? readings[0].reading : 0;
            const isWater = service === 'Water';
            const isElectricity = service === 'Electricity';
            const isHeat = service === 'Heat';
            
            // ТАРИФЫ
            
            if (isWater) {
                 // **Сложный калькулятор для воды с раздельными счетчиками и фиксированными тарифами**
                const latestReadingHVS = latestReading; // Используем общие показания для пре-заполнения ХВС
                
                return `
                    <div id="${service}-calculator" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">Калькулятор тарифов (Вода)</h3>

                        <!-- Тарифы (Справочно) -->
                        <div class="mb-5 p-3 bg-purple-50 rounded-lg border border-purple-200 text-sm">
                            <p><strong>Водопотребление (ХВС/ГВС):</strong> 46.10 руб./м³</p>
                            <p><strong>Водоотведение (общий расход):</strong> 35.17 руб./м³</p>
                            <!-- Hidden inputs for fixed tariffs -->
                            <input type="hidden" id="Water-calc-tariff-hvs" value="46.10">
                            <input type="hidden" id="Water-calc-tariff-disposal" value="35.17">
                        </div>

                        <div class="space-y-4">
                            <!-- 1. Холодное водоснабжение (ХВС) -->
                            <div class="p-3 border rounded-lg border-gray-200">
                                <p class="font-semibold mb-2 text-blue-700">1. Холодное водоснабжение (ХВС)</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="Water-calc-prev-hvs" class="block text-xs font-medium text-gray-700 mb-1">Предыдущее пок. (м³)</label>
                                        <input type="number" step="0.01" id="Water-calc-prev-hvs" 
                                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 focus:bg-white transition duration-150" 
                                            value="${latestReadingHVS.toFixed(2)}" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label for="Water-calc-current-hvs" class="block text-xs font-medium text-gray-700 mb-1">Текущее пок. (м³)</label>
                                        <input type="number" step="0.01" id="Water-calc-current-hvs" 
                                            class="w-full p-2 border border-blue-400 rounded-lg focus:ring-blue-500 transition duration-150" 
                                            value="" placeholder="0.00">
                                    </div>
                                </div>
                                <p id="Water-calc-consumption-hvs" class="mt-2 text-sm font-medium text-gray-600">Расход: 0.00 м³</p>
                            </div>

                            <!-- 2. ХВС на нужды ГВС (Горячая вода) -->
                            <div class="p-3 border rounded-lg border-gray-200">
                                <p class="font-semibold mb-2 text-orange-600">2. ХВС на нужды ГВС (Горячая вода)</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="Water-calc-prev-gvs" class="block text-xs font-medium text-gray-700 mb-1">Предыдущее пок. (м³)</label>
                                        <!-- Используем 0.00, так как предыдущие показания для ГВС не хранятся отдельно в текущей структуре Firestore -->
                                        <input type="number" step="0.01" id="Water-calc-prev-gvs" 
                                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 focus:bg-white transition duration-150" 
                                            value="0.00" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label for="Water-calc-current-gvs" class="block text-xs font-medium text-gray-700 mb-1">Текущее пок. (м³)</label>
                                        <input type="number" step="0.01" id="Water-calc-current-gvs" 
                                            class="w-full p-2 border border-orange-400 rounded-lg focus:ring-orange-500 transition duration-150" 
                                            value="" placeholder="0.00">
                                    </div>
                                </div>
                                <p id="Water-calc-consumption-gvs" class="mt-2 text-sm font-medium text-gray-600">Расход: 0.00 м³</p>
                            </div>
                        </div>

                        <!-- Итоговый расчет -->
                        <div class="mt-6 p-4 bg-purple-100 rounded-lg border-2 border-purple-300">
                            <p class="text-sm font-semibold text-purple-800">Общий расход (Вода + ГВС): <span id="Water-calc-total-consumption" class="font-extrabold">0.00 м³</span></p>
                            <p class="text-sm font-semibold text-purple-800 mt-2">Расчетная сумма к оплате:</p>
                            <p id="Water-calc-total-cost" class="text-3xl font-extrabold text-purple-900 mt-1">0.00 ₽</p>
                            <p id="Water-calc-details" class="text-xs mt-2 text-purple-700">Расчет: (Расход ХВС + Расход ГВС) * 46.10 + (Общий Расход) * 35.17</p>
                        </div>
                    </div>
                `;
            } else if (isElectricity) {
                 // **Сложный калькулятор для Электроэнергии (ДЕНЬ/НОЧЬ) с фиксированными тарифами**
                return `
                    <div id="${service}-calculator" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">Калькулятор тарифов (Энергия)</h3>

                        <!-- Тарифы (Справочно) -->
                        <div class="mb-5 p-3 bg-purple-50 rounded-lg border border-purple-200 text-sm grid grid-cols-2 gap-3">
                            <div>
                                <p class="font-semibold text-gray-700">Тариф ДЕНЬ (кВтч):</p>
                                <p class="text-base font-bold text-red-600">5.72 руб.</p>
                                <input type="hidden" id="Electricity-calc-tariff-day" value="5.72">
                            </div>
                            <div>
                                <p class="font-semibold text-gray-700">Тариф НОЧЬ (кВтч):</p>
                                <p class="text-base font-bold text-red-600">2.39 руб.</p>
                                <input type="hidden" id="Electricity-calc-tariff-night" value="2.39">
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- 1. ДНЕВНОЕ потребление -->
                            <div class="p-3 border rounded-lg border-gray-200">
                                <p class="font-semibold mb-2 text-yellow-700">1. ДЕНЬ (кВтч)</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="Electricity-calc-prev-day" class="block text-xs font-medium text-gray-700 mb-1">Предыдущее пок.</label>
                                        <input type="number" step="0.01" id="Electricity-calc-prev-day" 
                                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 focus:bg-white transition duration-150" 
                                            value="0.00" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label for="Electricity-calc-current-day" class="block text-xs font-medium text-gray-700 mb-1">Текущее пок.</label>
                                        <input type="number" step="0.01" id="Electricity-calc-current-day" 
                                            class="w-full p-2 border border-blue-400 rounded-lg focus:ring-blue-500 transition duration-150" 
                                            value="" placeholder="0.00">
                                    </div>
                                </div>
                                <p id="Electricity-calc-consumption-day" class="mt-2 text-sm font-medium text-gray-600">Расход: 0.00 кВтч</p>
                            </div>

                            <!-- 2. НОЧНОЕ потребление -->
                            <div class="p-3 border rounded-lg border-gray-200">
                                <p class="font-semibold mb-2 text-indigo-700">2. НОЧЬ (кВтч)</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="Electricity-calc-prev-night" class="block text-xs font-medium text-gray-700 mb-1">Предыдущее пок.</label>
                                        <input type="number" step="0.01" id="Electricity-calc-prev-night" 
                                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 focus:bg-white transition duration-150" 
                                            value="0.00" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label for="Electricity-calc-current-night" class="block text-xs font-medium text-gray-700 mb-1">Текущее пок.</label>
                                        <input type="number" step="0.01" id="Electricity-calc-current-night" 
                                            class="w-full p-2 border border-blue-400 rounded-lg focus:ring-blue-500 transition duration-150" 
                                            value="" placeholder="0.00">
                                    </div>
                                </div>
                                <p id="Electricity-calc-consumption-night" class="mt-2 text-sm font-medium text-gray-600">Расход: 0.00 кВтч</p>
                            </div>
                        </div>

                        <!-- Итоговый расчет -->
                        <div class="mt-6 p-4 bg-purple-100 rounded-lg border-2 border-purple-300">
                            <p class="text-sm font-semibold text-purple-800">Общий расход: <span id="Electricity-calc-total-consumption" class="font-extrabold">0.00 кВтч</span></p>
                            <p class="text-sm font-semibold text-purple-800 mt-2">Расчетная сумма к оплате:</p>
                            <p id="Electricity-calc-total-cost" class="text-3xl font-extrabold text-purple-900 mt-1">0.00 ₽</p>
                            <p class="text-xs mt-2 text-purple-700">Расчет: (Расход День * 5.72) + (Расход Ночь * 2.39)</p>
                        </div>
                    </div>
                `;
            } else if (isHeat) {
                // **Сложный калькулятор для ТЕПЛА (Отопление + Нагрев воды) с фиксированным тарифом**
                const latestReadingHeat = latestReading; 

                return `
                    <div id="${service}-calculator" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">Калькулятор тарифов (Тепло)</h3>

                        <!-- Тарифы (Справочно) -->
                        <div class="mb-5 p-3 bg-purple-50 rounded-lg border border-purple-200 text-sm grid grid-cols-1">
                            <div>
                                <p class="font-semibold text-gray-700">Тариф за Гкал (Отопление/Нагрев):</p>
                                <p class="text-base font-bold text-red-600">3134.17 руб./Гкал</p>
                                <input type="hidden" id="Heat-calc-tariff-gcal" value="3134.17">
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- 1. Отопление -->
                            <div class="p-3 border rounded-lg border-gray-200">
                                <p class="font-semibold mb-2 text-red-700">1. Отопление (Гкал)</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="Heat-calc-prev-heating" class="block text-xs font-medium text-gray-700 mb-1">Предыдущее пок.</label>
                                        <input type="number" step="0.000001" id="Heat-calc-prev-heating" 
                                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 focus:bg-white transition duration-150" 
                                            value="${latestReadingHeat.toFixed(6)}" placeholder="0.000000">
                                    </div>
                                    <div>
                                        <label for="Heat-calc-current-heating" class="block text-xs font-medium text-gray-700 mb-1">Текущее пок.</label>
                                        <input type="number" step="0.000001" id="Heat-calc-current-heating" 
                                            class="w-full p-2 border border-red-400 rounded-lg focus:ring-red-500 transition duration-150" 
                                            value="" placeholder="0.000000">
                                    </div>
                                </div>
                                <p id="Heat-calc-consumption-heating" class="mt-2 text-sm font-medium text-gray-600">Расход: 0.000000 Гкал</p>
                            </div>

                            <!-- 2. Тепловая энергия на нагрев воды -->
                            <div class="p-3 border rounded-lg border-gray-200">
                                <p class="font-semibold mb-2 text-orange-600">2. Нагрев воды (Гкал)</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="Heat-calc-prev-water" class="block text-xs font-medium text-gray-700 mb-1">Предыдущее пок.</label>
                                        <input type="number" step="0.000001" id="Heat-calc-prev-water" 
                                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 focus:bg-white transition duration-150" 
                                            value="0.000000" placeholder="0.000000">
                                    </div>
                                    <div>
                                        <label for="Heat-calc-current-water" class="block text-xs font-medium text-gray-700 mb-1">Текущее пок.</label>
                                        <input type="number" step="0.000001" id="Heat-calc-current-water" 
                                            class="w-full p-2 border border-red-400 rounded-lg focus:ring-red-500 transition duration-150" 
                                            value="" placeholder="0.000000">
                                    </div>
                                </div>
                                <p id="Heat-calc-consumption-water" class="mt-2 text-sm font-medium text-gray-600">Расход: 0.000000 Гкал</p>
                            </div>
                        </div>

                        <!-- Итоговый расчет -->
                        <div class="mt-6 p-4 bg-purple-100 rounded-lg border-2 border-purple-300">
                            <p class="text-sm font-semibold text-purple-800">Общий расход: <span id="Heat-calc-total-consumption" class="font-extrabold">0.000000 Гкал</span></p>
                            <p class="text-sm font-semibold text-purple-800 mt-2">Расчетная сумма к оплате:</p>
                            <p id="Heat-calc-total-cost" class="text-3xl font-extrabold text-purple-900 mt-1">0.00 ₽</p>
                            <p class="text-xs mt-2 text-purple-700">Расчет: (Расход Отопление + Расход Нагрев воды) * 3134.17</p>
                        </div>
                    </div>
                `;
            }
        }

        /** Логика расчета для калькулятора */
        function calculateUtilityCost(service) {
            const isWater = service === 'Water';
            const isElectricity = service === 'Electricity';
            const isHeat = service === 'Heat';
            const prefix = `${service}-calc-`; 

            if (isWater) {
                // ЛОГИКА ДЛЯ ВОДЫ (СЛОЖНАЯ)
                
                // 1. Inputs for HVS (Холодное водоснабжение)
                const prevHVS = parseFloat(document.getElementById(`${prefix}prev-hvs`)?.value) || 0;
                const currentHVS = parseFloat(document.getElementById(`${prefix}current-hvs`)?.value) || 0;

                // 2. Inputs for GVS (ХВС на нужды ГВС)
                const prevGVS = parseFloat(document.getElementById(`${prefix}prev-gvs`)?.value) || 0;
                const currentGVS = parseFloat(document.getElementById(`${prefix}current-gvs`)?.value) || 0;

                // Tariffs (from hidden inputs, hardcoded from the table)
                const tariffHVS = parseFloat(document.getElementById(`${prefix}tariff-hvs`)?.value) || 46.10;
                const tariffDisposal = parseFloat(document.getElementById(`${prefix}tariff-disposal`)?.value) || 35.17;

                // Consumption Calculations
                let consumptionHVS = (currentHVS >= prevHVS) ? currentHVS - prevHVS : 0;
                let consumptionGVS = (currentGVS >= prevGVS) ? currentGVS - prevGVS : 0;
                
                // Total Consumption
                const totalConsumption = consumptionHVS + consumptionGVS;

                // Cost Calculations
                const costHVS = consumptionHVS * tariffHVS;
                const costGVS = consumptionGVS * tariffHVS; // Same tariff 46.10
                const costDisposal = totalConsumption * tariffDisposal;
                
                // Total Final Cost
                const totalCost = costHVS + costGVS + costDisposal;

                // UI Updates
                const unit = 'м³';
                document.getElementById(`${prefix}consumption-hvs`).textContent = `Расход: ${consumptionHVS.toFixed(2)} ${unit}`;
                document.getElementById(`${prefix}consumption-gvs`).textContent = `Расход: ${consumptionGVS.toFixed(2)} ${unit}`;
                
                document.getElementById(`${prefix}total-consumption`).textContent = `${totalConsumption.toFixed(2)} ${unit}`;
                document.getElementById(`${prefix}total-cost`).textContent = formatCurrency(totalCost);
                
                return; 
            }
            
            if (isElectricity) {
                // ЛОГИКА ДЛЯ ЭЛЕКТРОЭНЕРГИИ (Двухтарифный)
                
                // Tariffs (Read from hidden/fixed fields)
                const tariffDay = parseFloat(document.getElementById(`${prefix}tariff-day`)?.value) || 5.72;
                const tariffNight = parseFloat(document.getElementById(`${prefix}tariff-night`)?.value) || 2.39;

                // Day Readings
                const prevDay = parseFloat(document.getElementById(`${prefix}prev-day`)?.value) || 0;
                const currentDay = parseFloat(document.getElementById(`${prefix}current-day`)?.value) || 0;
                
                // Night Readings
                const prevNight = parseFloat(document.getElementById(`${prefix}prev-night`)?.value) || 0;
                const currentNight = parseFloat(document.getElementById(`${prefix}current-night`)?.value) || 0;

                // Consumption
                const consumptionDay = (currentDay >= prevDay) ? currentDay - prevDay : 0;
                const consumptionNight = (currentNight >= prevNight) ? currentNight - prevNight : 0;
                const totalConsumption = consumptionDay + consumptionNight;

                // Cost
                const costDay = consumptionDay * tariffDay;
                const costNight = consumptionNight * tariffNight;
                const totalCost = costDay + costNight;

                // UI Updates
                const unit = 'кВтч';
                document.getElementById(`${prefix}consumption-day`).textContent = `Расход: ${consumptionDay.toFixed(2)} ${unit}`;
                document.getElementById(`${prefix}consumption-night`).textContent = `Расход: ${consumptionNight.toFixed(2)} ${unit}`;
                document.getElementById(`${prefix}total-consumption`).textContent = `${totalConsumption.toFixed(2)} ${unit}`;
                document.getElementById(`${prefix}total-cost`).textContent = formatCurrency(totalCost);
                
                return;
            } 
            
            if (isHeat) {
                // ЛОГИКА ДЛЯ ТЕПЛОВОЙ ЭНЕРГИИ (Отопление + Нагрев воды)
                
                // Tariff (Read from hidden/fixed field)
                const tariffGcal = parseFloat(document.getElementById(`${prefix}tariff-gcal`)?.value) || 3134.17;

                // 1. Heating Readings
                const prevHeating = parseFloat(document.getElementById(`${prefix}prev-heating`)?.value) || 0;
                const currentHeating = parseFloat(document.getElementById(`${prefix}current-heating`)?.value) || 0;
                
                // 2. Water Readings
                const prevWater = parseFloat(document.getElementById(`${prefix}prev-water`)?.value) || 0;
                const currentWater = parseFloat(document.getElementById(`${prefix}current-water`)?.value) || 0;

                // Consumption
                const consumptionHeating = (currentHeating >= prevHeating) ? currentHeating - prevHeating : 0;
                const consumptionWater = (currentWater >= prevWater) ? currentWater - prevWater : 0;
                const totalConsumption = consumptionHeating + consumptionWater;

                // Cost
                const totalCost = totalConsumption * tariffGcal;

                // UI Updates
                const unit = 'Гкал';
                document.getElementById(`${prefix}consumption-heating`).textContent = `Расход: ${consumptionHeating.toFixed(6)} ${unit}`; 
                document.getElementById(`${prefix}consumption-water`).textContent = `Расход: ${consumptionWater.toFixed(6)} ${unit}`; 
                document.getElementById(`${prefix}total-consumption`).textContent = `${totalConsumption.toFixed(6)} ${unit}`;
                document.getElementById(`${prefix}total-cost`).textContent = formatCurrency(totalCost);
                
                return;
            }
            
            // Если услуга не Water, Electricity, или Heat (т.е. Garbage, ManagementCompany) - нет калькулятора.
            // Никаких дополнительных действий не требуется.
        }
        
        /** Прикрепляет слушатели к калькулятору */
        function setupCalculatorListeners(service) {
            const isWater = service === 'Water';
            const isElectricity = service === 'Electricity';
            const isHeat = service === 'Heat';
            const prefix = `${service}-calc-`;

            let inputs = [];

            if (isWater) {
                // Слушатели для сложного калькулятора воды
                inputs = [
                    document.getElementById(`${prefix}prev-hvs`),
                    document.getElementById(`${prefix}current-hvs`),
                    document.getElementById(`${prefix}prev-gvs`),
                    document.getElementById(`${prefix}current-gvs`),
                ];
            } else if (isElectricity) {
                // Слушатели для двутарифного калькулятора энергии
                inputs = [
                    document.getElementById(`${prefix}prev-day`),
                    document.getElementById(`${prefix}current-day`),
                    document.getElementById(`${prefix}prev-night`),
                    document.getElementById(`${prefix}current-night`),
                ];
            } else if (isHeat) {
                 // Слушатели для калькулятора тепла
                inputs = [
                    document.getElementById(`${prefix}prev-heating`),
                    document.getElementById(`${prefix}current-heating`),
                    document.getElementById(`${prefix}prev-water`),
                    document.getElementById(`${prefix}current-water`),
                ];
            }
            
            // Назначаем обработчик на каждое поле, которое влияет на расчет
            inputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', () => calculateUtilityCost(service));
                }
            });
            
            // Выполнить первый расчет при инициализации
            calculateUtilityCost(service);
        }

        /** Рендеринг представления отдельной услуги (Форма + История) */
        function renderServiceView(service, readings) {
            const viewElement = document.getElementById(`${service}-view`);
            if (!viewElement) return;

            const displayName = getServiceDisplayName(service);
            const metered = isMetered(service);

            // Используем новую структуру с 2 колонками, где правая колонка содержит Калькулятор и Последние данные.
            viewElement.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">${displayName}</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Левая колонка: Форма ввода (Факт) -->
                        ${renderForm(service)}
                        
                        <!-- Правая колонка: Калькулятор и Последние данные -->
                        <div class="space-y-6">
                            ${metered ? renderCalculatorBlock(service, readings) : ''}
                            
                            <!-- Блок последних данных -->
                            <div class="p-4 sm:p-6 bg-white rounded-xl shadow-lg border-t-4 ${metered ? 'border-gray-300' : 'border-blue-500'}">
                                ${renderLatestInfoContent(service, readings)}
                            </div>
                        </div>
                    </div>
                    ${renderHistoryTable(service, readings)}
                </div>
            `;
            
            // Повторное прикрепление слушателя к основной форме
            const form = document.getElementById(`${service}-form`);
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const readingEl = document.getElementById(`${service}-reading`);
                    const costEl = document.getElementById(`${service}-cost`);
                    const notesEl = document.getElementById(`${service}-notes`);
                    
                    // Собираем данные
                    const reading = isMetered(service) ? parseFloat(readingEl.value) : 0;
                    const cost = parseFloat(costEl.value);
                    const notes = notesEl.value;

                    // Проверка на числовые поля
                    if ((isMetered(service) && isNaN(reading)) || isNaN(cost) || cost <= 0) {
                         showMessage('Пожалуйста, введите корректные числовые значения для показаний и суммы.', 'error');
                         return;
                    }

                    const readingData = { reading, cost, notes };

                    const success = await addReading(service, readingData);
                    if (success) {
                        form.reset();
                        // Если это услуга со счетчиком, можно предложить ввести следующее показание
                        if(readingEl) readingEl.focus(); 
                    }
                });
            }
            
            // Настройка слушателей калькулятора (только для счетчиков)
            if (metered) {
                 setupCalculatorListeners(service);
            }
        }
        
        /** Рендеринг представления Сводки */
        function renderSummaryView(allData, initialYear, initialMonth) {
            const summaryElement = document.getElementById('Summary-view');
            if (!summaryElement) return;
            
            const availableYears = getAvailableYears(allData);
            
            // Определяем текущие фильтры, используя значения из UI, если они уже существуют
            let selectedYear = initialYear;
            let selectedMonth = initialMonth;
            
            const yearSelect = document.getElementById('summary-year');
            const monthSelect = document.getElementById('summary-month');

            if (yearSelect && monthSelect) {
                 selectedYear = parseInt(yearSelect.value);
                 selectedMonth = parseInt(monthSelect.value);
            } else if (availableYears.length > 0) {
                 // Устанавливаем год по умолчанию на самый новый
                 selectedYear = availableYears[0];
            }


            // 1. Фильтрация данных по выбранному году и месяцу
            let filteredReadings = {};
            let totalCost = 0;
            let costByService = {};

            for (const service of serviceKeys) {
                // ИСПРАВЛЕНИЕ: Используем оператор || [], чтобы гарантировать, что мы фильтруем массив, даже если allData[service] еще не определен (при первой загрузке).
                filteredReadings[service] = (allData[service] || []).filter(item => {
                    if (!item.createdAt) return false;
                    const date = item.createdAt.toDate();
                    // Фильтруем по году И месяцу.
                    // Если выбран "Все месяцы" (значение -1), фильтруем только по году.
                    const isYearMatch = date.getFullYear() === selectedYear;
                    const isMonthMatch = selectedMonth === -1 || date.getMonth() === selectedMonth;
                    return isYearMatch && isMonthMatch;
                });
                
                // Расчет общих затрат ТОЛЬКО по отфильтрованным данным
                const serviceTotal = filteredReadings[service].reduce((sum, item) => sum + item.cost, 0);
                costByService[service] = serviceTotal;
                totalCost += serviceTotal;
            }
            
            // 2. Генерация селекторов Года
            const yearOptions = availableYears.map(year => 
                `<option value="${year}" ${year === selectedYear ? 'selected' : ''}>${year} год</option>`
            ).join('');
            
            // 3. Генерация селекторов Месяца
            const monthOptions = [
                `<option value="-1">Все месяцы</option>`,
                ...Array.from({ length: 12 }, (_, i) => 
                    `<option value="${i}" ${i === selectedMonth ? 'selected' : ''}>${getMonthName(i)}</option>`
                )
            ].join('');

            // 4. Рендеринг карточек услуг
            const serviceCards = serviceKeys.map(service => {
                const displayName = getServiceDisplayName(service);
                // Берем последнее значение из ПОЛНОГО массива данных (для корректного отображения "Посл. оплаты")
                const latestReading = (allData[service] || []).length > 0 ? (allData[service] || [])[0] : null; // Безопасный доступ
                const serviceCost = costByService[service] || 0;
                
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 hover:shadow-xl transition duration-300">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">${displayName}</h3>
                        <p class="text-sm text-gray-500">Затраты за период:</p>
                        <p class="text-2xl font-bold ${serviceCost > 0 ? 'text-red-600' : 'text-gray-500'} mb-3">${formatCurrency(serviceCost)}</p>
                        
                        ${latestReading ? `
                            <div class="text-xs pt-3 border-t border-gray-100">
                                <p>Посл. оплата (всего): <span class="font-medium">${formatCurrency(latestReading.cost)}</span></p>
                                <p>Дата: ${formatDate(latestReading.createdAt)}</p>
                            </div>
                        ` : `
                            <p class="text-xs text-gray-400 pt-3 border-t border-gray-100">Нет данных</p>
                        `}
                    </div>
                `;
            }).join('');
            
            // 5. Обновление HTML Сводки
            summaryElement.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Сводка по Коммунальным Услугам</h2>
                    
                    <!-- Селекторы Месяца и Года -->
                    <div class="mb-8 p-4 bg-white rounded-xl shadow-md flex flex-wrap gap-4 items-center">
                        <p class="font-medium text-gray-700">Просмотр периода:</p>
                        <select id="summary-month" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 min-w-[150px]">
                            ${monthOptions}
                        </select>
                        <select id="summary-year" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 min-w-[120px]">
                            ${yearOptions.length > 0 ? yearOptions : '<option value="">Нет данных</option>'}
                        </select>
                    </div>

                    <!-- Карточка общих расходов за период -->
                    <div class="mb-8 p-6 bg-blue-600 text-white rounded-xl shadow-2xl transform transition duration-300">
                        <p class="text-lg font-medium">Общие затраты за выбранный период:</p>
                        <p class="text-5xl font-extrabold mt-1">${formatCurrency(totalCost)}</p>
                    </div>

                    <!-- Карточки по услугам за период -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                        ${serviceCards}
                    </div>
                    
                    <!-- Блок аналитики -->
                    <div class="mt-12 p-6 bg-gray-50 rounded-xl border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Начните работу</h3>
                        <p class="text-gray-600">Выберите вкладку выше, чтобы добавить показания счетчиков или внести платежи. Все данные будут автоматически суммированы на этом экране!</p>
                    </div>
                </div>
            `;
            
            // 6. Прикрепление слушателей событий после рендеринга
            const newYearSelect = document.getElementById('summary-year');
            const newMonthSelect = document.getElementById('summary-month');

            if (newYearSelect) {
                newYearSelect.addEventListener('change', () => {
                    const year = parseInt(newYearSelect.value);
                    const month = parseInt(newMonthSelect.value);
                    renderSummaryView(allData, year, month);
                });
            }
            if (newMonthSelect) {
                newMonthSelect.addEventListener('change', () => {
                    const year = parseInt(newYearSelect.value);
                    const month = parseInt(newMonthSelect.value);
                    renderSummaryView(allData, year, month);
                });
            }
        }

        // --- Логика навигации и UI ---

        let currentView = 'Summary';

        /** Переключает видимость представлений */
        function switchView(viewName) {
            if (currentView === viewName) return;

            // Скрыть все представления
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            
            // Показать целевое представление
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
                currentView = viewName;
            }

            // Обновление активного состояния в навигации
            document.querySelectorAll('.nav-item a').forEach(a => {
                a.classList.remove('current-view');
            });

            const activeLink = document.querySelector(`.nav-item a[data-view="${viewName}"]`);
            if (activeLink) {
                activeLink.classList.add('current-view');
            }
            
            // Закрыть мобильное меню после выбора
            const navMenu = document.getElementById('nav-menu');
            if (!navMenu.classList.contains('hidden-mobile')) {
                 navMenu.classList.add('hidden-mobile');
            }
        }
        
        /** Инициализация приложения при загрузке страницы */
        window.onload = function() {
            // 1. Инициализация Firebase и Аутентификации
            initializeFirebase();

            // 2. Настройка слушателей для навигации
            document.querySelectorAll('.nav-item a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = e.target.getAttribute('data-view');
                    if (viewName) {
                        switchView(viewName);
                    }
                });
            });

            // 3. Переключатель мобильного меню
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('nav-menu').classList.toggle('hidden-mobile');
            });
            
            // 4. Установка начального представления с текущим годом и месяцем
            const defaultYear = new Date().getFullYear();
            const defaultMonth = new Date().getMonth(); // 0-11
            
            // Сначала рендерим пустую сводку для установки селекторов
            renderSummaryView(allReadings, defaultYear, defaultMonth);
            switchView(currentView);
        };
    </script>
</body>
</html>
